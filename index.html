<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Workout Studio Pro (Merged)</title>
  <style>
    :root {
      --bg: #000000;
      --panel: #1c1c1e;
      --accent: #30d158;
      --text: #ffffff;
      --muted: #8e8e93;
      --border: #38383a;
      --shadow: 0 8px 22px rgba(0,0,0,0.45);
      --danger: #ff453a;
      --ok: #30d158;
      --focus: 0 0 0 3px rgba(48, 209, 88, .25);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    /* Layout Principale */
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      padding: 18px 16px 10px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    .header h1 { margin: 0; font-size: 26px; font-weight: 900; letter-spacing: .2px; }
    .header .subtitle {
      font-size: 12px;
      color: var(--accent);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 800;
    }

    .content-area { flex: 1; overflow-y: auto; padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
    .list-container { padding: 16px; display: flex; flex-direction: column; gap: 12px; }

    /* Tab Bar */
    .tab-bar {
      position: fixed; bottom: 0; width: 100%; height: 70px;
      background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      padding-bottom: env(safe-area-inset-bottom);
      z-index: 1000;
    }
    .tab-item {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: var(--muted); cursor: pointer; transition: 0.2s;
      user-select: none;
    }
    .tab-item.active { color: var(--accent); }
    .tab-icon { font-size: 22px; margin-bottom: 4px; }
    .tab-label { font-size: 10px; font-weight: 800; letter-spacing: .4px; }

    /* Cards / Liste */
    .card {
      background: var(--panel);
      border-radius: 16px;
      padding: 14px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: var(--shadow);
    }
    .card.active { outline: 2px solid rgba(48, 209, 88, .55); outline-offset: 2px; }
    .card-info { display: flex; gap: 12px; align-items: center; }
    .preview-thumb {
      width: 52px; height: 52px; border-radius: 10px; background: #333;
      object-fit: cover; border: 1px solid var(--border);
      flex: 0 0 auto;
    }
    .card-text h3 { margin: 0; font-size: 16px; font-weight: 900; }
    .card-text p { margin: 4px 0 0; font-size: 12px; color: var(--muted); }

    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

    button {
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      touch-action: manipulation;
    }
    button:focus { outline: none; box-shadow: var(--focus); }
    .btn-main {
      background: var(--accent);
      color: #000;
      width: 100%;
      justify-content: center;
      padding: 14px;
      font-size: 16px;
      border-color: rgba(0,0,0,.12);
    }
    .btn-icon { background: #3a3a3c; color: #fff; border-color: rgba(255,255,255,.06); }
    .btn-danger { background: rgba(255, 69, 58, 0.16); color: var(--danger); border-color: rgba(255, 69, 58, 0.20); }
    .btn-ok { background: rgba(48, 209, 88, .18); color: var(--ok); border-color: rgba(48, 209, 88, .25); }
    .btn-ghost { background: rgba(255,255,255,.06); color: #fff; border-color: rgba(255,255,255,.08); }

    .row { display:flex; gap:10px; align-items:center; }
    .grow { flex: 1; }

    input, select, textarea {
      width: 100%;
      background: #2c2c2e;
      border: 1px solid var(--border);
      color: #fff;
      padding: 12px;
      border-radius: 14px;
      margin: 8px 0;
      font: inherit;
    }
    input:focus, select:focus, textarea:focus { outline:none; box-shadow: var(--focus); }
    textarea { min-height: 92px; resize: vertical; }

    .hint { color: var(--muted); font-size: 12px; margin: 0; line-height: 1.4; }
    .pill {
      display:inline-flex; align-items:center; gap:8px;
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--muted);
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Player */
    .player-view { display: flex; flex-direction: column; align-items: center; gap: 16px; padding: 16px; }
    .screen {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 20px;
      position: relative;
      overflow: hidden;
      border: 2px solid var(--border);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      transform: translateZ(0);
    }
    .screen::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,.10), rgba(255,255,255,0) 30%, rgba(255,255,255,.04));
      pointer-events:none;
    }
    .player-title {
      position:absolute; left:15px; top:15px;
      font-weight: 900;
      text-shadow: 2px 2px 6px rgba(0,0,0,.75);
      max-width: 62%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      z-index: 2;
    }
    .timer-display {
      position: absolute; top: 12px; right: 12px;
      background: rgba(0,0,0,0.55);
      padding: 5px 10px;
      border-radius: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 18px;
      color: var(--accent);
      z-index: 2;
    }
    .player-media {
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 54px 12px 70px;
      z-index: 1;
      position: relative;
    }
    .player-media img, .player-media video {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .player-empty { color: var(--muted); font-weight: 700; text-align:center; padding: 16px; }

    .countdown-overlay{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      font-size: 84px;
      font-weight: 1000;
      background: rgba(0,0,0,0.35);
      color: #fff;
      text-shadow: 0 2px 18px rgba(0,0,0,.7);
      z-index: 3;
      pointer-events: none;
    }

    .player-bottom {
      position:absolute;
      left: 12px; right: 12px; bottom: 12px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      z-index: 4;
    }

    /* Timeline */
    .timeline {
      width: 100%;
      overflow-x: auto;
      display: flex;
      gap: 6px;
      padding: 10px 2px;
      scrollbar-width: none;
    }
    .timeline::-webkit-scrollbar { display:none; }
    .timeline-item {
      min-width: 84px;
      height: 48px;
      background: #3a3a3c;
      border-radius: 10px;
      flex-shrink: 0;
      font-size: 10px;
      padding: 6px;
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      border: 1px solid rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      user-select: none;
    }
    .timeline-item.active {
      border-color: rgba(48, 209, 88, .9);
      background: #48484a;
    }

    .btn-avvia {
      background: linear-gradient(135deg, #30d158, #28a745);
      color: #000;
      padding: 18px 54px;
      border-radius: 40px;
      font-size: 18px;
      box-shadow: 0 12px 32px rgba(48, 209, 88, 0.25);
      transform: scale(1);
      transition: 0.15s;
      border: 1px solid rgba(0,0,0,.12);
    }
    .btn-avvia:active { transform: scale(0.97); }

    /* Modal */
    .hidden { display: none !important; }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.78);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal {
      background: var(--panel);
      width: 92%;
      max-width: 540px;
      border-radius: 24px;
      padding: 18px;
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 20px 55px rgba(0,0,0,.55);
    }
    .modal h2 { margin: 0 0 8px; font-size: 18px; font-weight: 1000; }
    .modal .err { color: var(--danger); font-weight: 800; font-size: 12px; display:none; }

    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(86px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(28,28,30,0.95);
      color: #fff;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      font-size: 13px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display: none;
      z-index: 2500;
      max-width: 92vw;
      text-align: center;
      border: 1px solid rgba(255,255,255,.08);
    }

    /* ===== PSEUDO FULLSCREEN (iPhone friendly) ===== */
    .pseudo-fullscreen {
      position: fixed !important;
      inset: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      border-radius: 0 !important;
      z-index: 9999 !important;
    }
    .hide-when-pseudo { display: none !important; }

    /* iOS click/blur fix */
    .screen, .player-bottom { transform: translateZ(0); }
  </style>
</head>
<body>

  <div class="app-container">
    <header class="header" id="appHeader">
      <h1 id="pageTitle">PROGETTI</h1>
      <div id="pageSubtitle" class="subtitle">I tuoi allenamenti</div>
    </header>

    <main class="content-area" id="contentArea">
      <!-- PROGETTI -->
      <div id="view-progetti" class="list-container">
        <div class="card">
          <div class="row" style="align-items:flex-start">
            <div class="grow">
              <div class="pill" id="projectBadge" title="Progetto corrente">Progetto: (nuovo)</div>
              <p class="hint" style="margin-top:10px">
                <b>Salva</b> aggiorna il progetto caricato. Se non hai caricato nulla, salva come nuovo.
              </p>
            </div>
          </div>

          <label style="font-weight:900; font-size:12px; color:rgba(255,255,255,.85)">
            Nome progetto
            <input id="projectName" type="text" placeholder="Nome progetto..." />
          </label>

          <div class="btn-group">
            <button id="saveProjectBtn" class="btn-ok">üíæ Salva</button>
            <button id="saveAsNewBtn" class="btn-ghost">üß∑ Salva come nuovo</button>
            <button id="newProjectBtn" class="btn-icon">‚ûï Nuovo</button>
          </div>
        </div>

        <div id="projectList"></div>
        <p id="noProjects" class="hint">Nessun progetto salvato.</p>
      </div>

      <!-- SEZIONI -->
      <div id="view-sezioni" class="list-container hidden">
        <button class="btn-main" id="addSectionBtn">+ Aggiungi Sezione</button>
        <div id="sectionList"></div>
        <p id="emptyState" class="hint">Nessuna sezione ancora. Premi ‚ÄúAggiungi Sezione‚Äù.</p>
      </div>

      <!-- SCHERMO -->
      <div id="view-schermo" class="player-view hidden">
        <div id="mainScreen" class="screen" aria-label="Player">
          <div id="playerTitle" class="player-title">Nessun progetto</div>
          <div id="timerDisplay" class="timer-display">00:00</div>

          <div id="playerMedia" class="player-media">
            <div class="player-empty">Seleziona un progetto e poi vai su <b>SEZIONI</b> o <b>SCHERMO</b>.</div>
          </div>

          <div id="countdownOverlay" class="countdown-overlay">3</div>

          <div class="player-bottom">
            <button class="btn-icon" id="backBtn">‚óÄ</button>
            <button class="btn-icon" id="fullscreenBtn">‚õ∂</button>
            <button class="btn-icon" id="nextBtn">‚ñ∂</button>
          </div>
        </div>

        <div class="timeline" id="timelineBar"></div>

        <button class="btn-avvia" id="btnAvviaWorkout">AVVIA</button>
        <p class="hint" style="text-align:center; max-width: 520px">
          ‚ÄúAVVIA‚Äù fa partire il timer allenamento. Le sezioni con countdown avanzano da sole.
        </p>
      </div>
    </main>

    <nav class="tab-bar" id="tabBar">
      <div class="tab-item active" data-tab="progetti">
        <span class="tab-icon">üìÅ</span>
        <span class="tab-label">PROGETTI</span>
      </div>
      <div class="tab-item" data-tab="sezioni">
        <span class="tab-icon">‚úèÔ∏è</span>
        <span class="tab-label">SEZIONI</span>
      </div>
      <div class="tab-item" data-tab="schermo">
        <span class="tab-icon">üì∫</span>
        <span class="tab-label">SCHERMO</span>
      </div>
    </nav>
  </div>

  <!-- MODAL SEZIONE -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <h2 id="modalTitle">Nuova Sezione</h2>

      <label style="font-weight:900; font-size:12px; color:rgba(255,255,255,.85)">
        Tipo sezione
        <select id="typeSelect">
          <option value="esercizio">Esercizio</option>
          <option value="countdown">Countdown (Riposo)</option>
        </select>
      </label>

      <div id="formEsercizio">
        <input id="exTitle" type="text" placeholder="Titolo (es. Push up)" />
        <input id="exMediaFile" type="file" accept="image/*,video/*,.gif" />
        <input id="exMediaLink" type="url" placeholder="Link media (consigliato per file pesanti)" />
        <textarea id="exNotes" placeholder="Note..."></textarea>

        <label style="font-weight:900; font-size:12px; color:rgba(255,255,255,.85)">
          Cambio schermata
          <select id="exChangeMode">
            <option value="avanti">Manuale (tasto avanti)</option>
            <option value="countdown">Automatico (countdown)</option>
          </select>
        </label>

        <div id="exSecondsWrap" class="hidden">
          <input id="exSeconds" type="number" min="1" step="1" value="30" placeholder="Secondi countdown" />
        </div>
      </div>

      <div id="formCountdown" class="hidden">
        <input id="cdTitle" type="text" placeholder="Nome countdown (es. Riposo)" value="Riposo" />
        <input id="cdSeconds" type="number" min="1" step="1" value="30" placeholder="Secondi" />
      </div>

      <div id="errorMsg" class="err"></div>

      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn-icon" style="flex:1" id="cancelBtn">Annulla</button>
        <button class="btn-main" style="flex:1; margin:0" id="saveSectionBtn">Salva</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // =========================
    // Robust storage: IndexedDB -> localStorage fallback (da index.html)
    // =========================
    const STORAGE = (() => {
      const DB_NAME = 'castelli_db_v2';
      const STORE = 'kv';
      const KEY = 'projects';

      let db = null;

      function openDB() {
        return new Promise((resolve) => {
          if (!('indexedDB' in window)) return resolve(null);
          const req = indexedDB.open(DB_NAME, 1);
          req.onupgradeneeded = () => {
            const d = req.result;
            if (!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE);
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => resolve(null);
        });
      }

      async function ensure() {
        if (db !== null) return db;
        db = await openDB();
        return db;
      }

      async function idbGet() {
        const d = await ensure();
        if (!d) return null;
        return new Promise((resolve) => {
          const tx = d.transaction(STORE, 'readonly');
          const st = tx.objectStore(STORE);
          const r = st.get(KEY);
          r.onsuccess = () => resolve(r.result ?? null);
          r.onerror = () => resolve(null);
        });
      }

      async function idbSet(value) {
        const d = await ensure();
        if (!d) return false;
        return new Promise((resolve) => {
          const tx = d.transaction(STORE, 'readwrite');
          const st = tx.objectStore(STORE);
          const r = st.put(value, KEY);
          r.onsuccess = () => resolve(true);
          r.onerror = () => resolve(false);
        });
      }

      function lsGet() {
        try {
          const raw = localStorage.getItem('castelli_projects_fallback_v2');
          return raw ? JSON.parse(raw) : null;
        } catch { return null; }
      }

      function lsSet(value) {
        try {
          localStorage.setItem('castelli_projects_fallback_v2', JSON.stringify(value));
          return true;
        } catch { return false; }
      }

      return {
        async loadProjects() {
          const fromIDB = await idbGet();
          if (fromIDB) return fromIDB;

          const fromLS = lsGet();
          if (fromLS) return fromLS;

          return [];
        },
        async saveProjects(projects) {
          const okIDB = await idbSet(projects);
          if (okIDB) return { ok: true, where: 'IndexedDB' };

          const okLS = lsSet(projects);
          if (okLS) return { ok: true, where: 'localStorage' };

          return { ok: false, where: 'none' };
        }
      };
    })();

    // =========================
    // DOM
    // =========================
    const pageTitle = document.getElementById('pageTitle');
    const pageSubtitle = document.getElementById('pageSubtitle');

    const viewProgetti = document.getElementById('view-progetti');
    const viewSezioni = document.getElementById('view-sezioni');
    const viewSchermo = document.getElementById('view-schermo');

    const tabItems = Array.from(document.querySelectorAll('.tab-item'));

    const projectList = document.getElementById('projectList');
    const noProjects = document.getElementById('noProjects');
    const projectNameInput = document.getElementById('projectName');
    const saveProjectBtn = document.getElementById('saveProjectBtn');
    const saveAsNewBtn = document.getElementById('saveAsNewBtn');
    const newProjectBtn = document.getElementById('newProjectBtn');
    const projectBadge = document.getElementById('projectBadge');

    const addSectionBtn = document.getElementById('addSectionBtn');
    const sectionList = document.getElementById('sectionList');
    const emptyState = document.getElementById('emptyState');

    const screen = document.getElementById('mainScreen');
    const playerTitle = document.getElementById('playerTitle');
    const playerMedia = document.getElementById('playerMedia');
    const timerDisplay = document.getElementById('timerDisplay');
    const countdownOverlay = document.getElementById('countdownOverlay');

    const backBtn = document.getElementById('backBtn');
    const nextBtn = document.getElementById('nextBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const btnAvviaWorkout = document.getElementById('btnAvviaWorkout');

    const backdrop = document.getElementById('backdrop');
    const modalTitle = document.getElementById('modalTitle');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveSectionBtn = document.getElementById('saveSectionBtn');
    const errorMsg = document.getElementById('errorMsg');

    const typeSelect = document.getElementById('typeSelect');
    const formEsercizio = document.getElementById('formEsercizio');
    const formCountdown = document.getElementById('formCountdown');

    const exTitle = document.getElementById('exTitle');
    const exMediaFile = document.getElementById('exMediaFile');
    const exMediaLink = document.getElementById('exMediaLink');
    const exNotes = document.getElementById('exNotes');
    const exChangeMode = document.getElementById('exChangeMode');
    const exSecondsWrap = document.getElementById('exSecondsWrap');
    const exSeconds = document.getElementById('exSeconds');

    const cdTitle = document.getElementById('cdTitle');
    const cdSeconds = document.getElementById('cdSeconds');

    const timelineBar = document.getElementById('timelineBar');

    const toast = document.getElementById('toast');

    // =========================
    // State
    // =========================
    let sections = [];
    let editingIndex = null;

    let currentProjectId = null;
    let currentProjectName = 'Nuovo Progetto';

    let currentIndex = 0;

    // Workout timer
    let workoutTimer = null;
    let workoutSeconds = 0;
    let workoutFinishedSeconds = null; // tempo finale congelato

    // Countdown
    let countdownTimer = null;
    let countdownRemaining = 0;

    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    // =========================
    // Schermata finale (non modificabile)
    // =========================
    const FINISH_SECTION = {
      type: 'finish',
      locked: true,
      title: 'Allenamento completato'
    };

    function effectiveSections(){
      // Mostra la schermata finale solo se c'√® almeno 1 sezione reale
      return sections.length ? [...sections, FINISH_SECTION] : [];
    }

    function formatDuration(totalSeconds){
      const s = Math.max(0, totalSeconds || 0);
      const mins = Math.floor(s / 60);
      const secs = s % 60;
      return `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    }


    // =========================
    // Toast
    // =========================
    function showToast(msg) {
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.style.display = 'none', 2200);
    }

    // =========================
    // Helpers
    // =========================
    function clearError(){ errorMsg.style.display='none'; errorMsg.textContent=''; }
    function showError(msg){ errorMsg.textContent=msg; errorMsg.style.display='block'; }

    function formatSectionLabel(s) {
      if (s.type === 'countdown') return `${(s.title && s.title.trim()) ? s.title.trim() : 'Countdown'} ‚Ä¢ ${s.seconds}s`;
      const title = (s.title && s.title.trim()) ? s.title.trim() : 'Esercizio';
      const mode = s.changeMode === 'avanti' ? 'Avanti' : `Countdown ${s.seconds}s`;
      return `${title} ‚Ä¢ ${mode}`;
    }

    function metaFor(s) {
      const parts = [];
      if (s.type === 'countdown') parts.push('Riposo');
      if (s.media && s.media.kind) parts.push(`Media: ${s.media.kind}`);
      if (s.notes) parts.push('Note: s√¨');
      return parts.length ? parts.join(' ‚Ä¢ ') : 'Nessun dettaglio aggiuntivo';
    }

    async function setBadge() {
      if (!currentProjectId) {
        projectBadge.textContent = 'Progetto: (nuovo)';
        return;
      }
      const projects = await STORAGE.loadProjects();
      const p = projects.find(x => x.id === currentProjectId);
      projectBadge.textContent = p ? `Progetto: ${p.name}` : 'Progetto: (nuovo)';
    }

    function detachCurrentProject() {
      currentProjectId = null;
      currentProjectName = 'Nuovo Progetto';
      projectNameInput.value = '';
      setBadge();
    }

    // =========================
    // Tabs
    // =========================
    function switchTab(tab) {
      tabItems.forEach(i => i.classList.toggle('active', i.dataset.tab === tab));
      viewProgetti.classList.toggle('hidden', tab !== 'progetti');
      viewSezioni.classList.toggle('hidden', tab !== 'sezioni');
      viewSchermo.classList.toggle('hidden', tab !== 'schermo');

      if (tab === 'progetti') {
        pageTitle.innerText = "PROGETTI";
        pageSubtitle.innerText = "I tuoi allenamenti";
        renderProjects();
      } else if (tab === 'sezioni') {
        pageTitle.innerText = "SEZIONI";
        pageSubtitle.innerText = "Editor: " + currentProjectName;
        renderSections();
      } else {
        pageTitle.innerText = "SCHERMO";
        pageSubtitle.innerText = "Visualizzazione: " + currentProjectName;
        renderPlayer();
        renderTimeline();
      }
    }

    tabItems.forEach(item => item.addEventListener('click', () => switchTab(item.dataset.tab)));

    // =========================
    // Modal
    // =========================
    function switchTypeUI() {
      const t = typeSelect.value;
      formEsercizio.classList.toggle('hidden', t !== 'esercizio');
      formCountdown.classList.toggle('hidden', t !== 'countdown');
    }
    function switchExerciseModeUI() {
      const m = exChangeMode.value;
      exSecondsWrap.classList.toggle('hidden', m !== 'countdown');
    }

    function resetFormDefaults() {
      typeSelect.value = 'esercizio';
      switchTypeUI();

      exTitle.value = '';
      exMediaFile.value = '';
      exMediaLink.value = '';
      exNotes.value = '';
      exChangeMode.value = 'avanti';
      exSeconds.value = 30;
      exSecondsWrap.classList.add('hidden');

      cdTitle.value = 'Riposo';
      cdSeconds.value = 30;
    }

    function fillFormFromSection(s) {
      typeSelect.value = s.type;
      switchTypeUI();

      if (s.type === 'countdown') {
        cdTitle.value = s.title ?? 'Riposo';
        cdSeconds.value = s.seconds ?? 30;
        return;
      }

      exTitle.value = s.title ?? '';
      exMediaFile.value = '';
      exMediaLink.value = (s.media && s.media.kind === 'link') ? (s.media.src ?? '') : '';
      exNotes.value = s.notes ?? '';
      exChangeMode.value = s.changeMode ?? 'avanti';

      if (exChangeMode.value === 'countdown') {
        exSecondsWrap.classList.remove('hidden');
        exSeconds.value = s.seconds ?? 30;
      } else {
        exSecondsWrap.classList.add('hidden');
        exSeconds.value = 30;
      }
    }

    function openModal(mode, idx = null) {
      clearError();
      backdrop.style.display = 'flex';
      editingIndex = (mode === 'edit') ? idx : null;

      if (editingIndex === null) {
        modalTitle.textContent = 'Nuova Sezione';
        resetFormDefaults();
      } else {
        modalTitle.textContent = 'Modifica Sezione';
        fillFormFromSection(sections[editingIndex]);
      }
    }

    function closeModalFn() {
      backdrop.style.display = 'none';
      editingIndex = null;
    }

    backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModalFn(); });
    cancelBtn.addEventListener('click', closeModalFn);
    typeSelect.addEventListener('change', () => { clearError(); switchTypeUI(); });
    exChangeMode.addEventListener('change', () => { clearError(); switchExerciseModeUI(); });

    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    async function readSectionFromForm() {
      const t = typeSelect.value;

      if (t === 'countdown') {
        const seconds = parseInt(cdSeconds.value, 10);
        if (!Number.isFinite(seconds) || seconds < 1) {
          showError('Inserisci un numero di secondi valido (>= 1).');
          return null;
        }
        const title = cdTitle.value.trim() || 'Riposo';
        return { type: 'countdown', title, seconds };
      }

      const title = exTitle.value.trim();
      const mediaLink = exMediaLink.value.trim();
      const notes = exNotes.value.trim();

      const changeMode = exChangeMode.value;
      let seconds = null;

      if (changeMode === 'countdown') {
        const s = parseInt(exSeconds.value, 10);
        if (!Number.isFinite(s) || s < 1) {
          showError('Inserisci un numero di secondi valido (>= 1) per il countdown.');
          return null;
        }
        seconds = s;
      }

      const file = exMediaFile.files && exMediaFile.files[0] ? exMediaFile.files[0] : null;
      let media = null;

      if (mediaLink) {
        media = { kind: 'link', src: mediaLink };
      } else if (file) {
        try {
          const dataUrl = await fileToDataURL(file);
          if (dataUrl.length > 3_500_000) {
            showError('Il file √® troppo grande per essere salvato. Usa un link o un file pi√π leggero.');
            return null;
          }
          media = { kind: file.type.startsWith('video/') ? 'video' : 'image', src: dataUrl };
        } catch {
          showError('Errore nel leggere il file. Riprova oppure usa un link.');
          return null;
        }
      } else if (editingIndex !== null) {
        media = sections[editingIndex].media ?? null;
      }

      return {
        type: 'esercizio',
        title: title || null,
        media,
        notes: notes || null,
        changeMode,
        seconds
      };
    }

    saveSectionBtn.addEventListener('click', async () => {
      clearError();
      const s = await readSectionFromForm();
      if (!s) return;

      if (editingIndex === null) sections.push(s);
      else sections[editingIndex] = s;

      closeModalFn();
      renderSections();
      showToast(editingIndex === null ? 'Sezione creata' : 'Sezione modificata');
    });

    addSectionBtn.addEventListener('click', () => openModal('create'));

    // =========================
    // Player logic (da index.html, adattata)
    // =========================
    function stopCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = null;
      countdownOverlay.style.display = 'none';
    }

    function setMediaContent(section) {
      playerMedia.innerHTML = '';

      if (!section) {
        playerTitle.textContent = 'Nessun progetto';
        playerMedia.innerHTML = `<div class="player-empty">Seleziona un progetto.</div>`;
        return;
      }

      
      // Schermata finale fissa
      if (section.type === 'finish') {
        playerTitle.textContent = section.title || 'Allenamento completato';
        const finalSec = (workoutFinishedSeconds !== null) ? workoutFinishedSeconds : workoutSeconds;
        playerMedia.innerHTML = `
          <div class="player-empty" style="font-size:16px; line-height:1.5">
            <div style="font-weight:1000; font-size:20px; margin-bottom:8px">Hai finito il tuo allenamento! üéâ</div>
            <div style="color:rgba(255,255,255,.85); margin-bottom:8px">Ci hai messo <b>${formatDuration(finalSec)}</b></div>
            <div style="color:rgba(255,255,255,.6); font-size:12px">Puoi tornare indietro per rivedere le schermate.</div>
          </div>
        `;
        return;
      }
if (section.type === 'countdown') {
        playerTitle.textContent = (section.title && section.title.trim()) ? section.title.trim() : 'Riposo';
        playerMedia.innerHTML = '';
        return;
      }

      playerTitle.textContent = (section.title && section.title.trim()) ? section.title.trim() : 'Esercizio';

      const media = section.media;
      if (!media || !media.src) {
        playerMedia.innerHTML = `<div class="player-empty">Nessun media inserito.</div>`;
        return;
      }

      const src = media.src;
      const isVideo =
        media.kind === 'video' ||
        (media.kind === 'link' && /\.(mp4|webm|ogg)(\?.*)?$/i.test(src));

      if (isVideo) {
        const v = document.createElement('video');
        v.src = src;
        v.controls = true;
        v.playsInline = true;
        v.loop = true;
        v.autoplay = true;
        v.muted = true;
        playerMedia.appendChild(v);
      } else {
        const img = document.createElement('img');
        img.src = src;
        img.alt = playerTitle.textContent;
        playerMedia.appendChild(img);
      }
    }

    function startCountdown(seconds, onDone) {
      stopCountdown();
      countdownRemaining = seconds;

      countdownOverlay.textContent = countdownRemaining;
      countdownOverlay.style.display = 'flex';

      countdownTimer = setInterval(() => {
        countdownRemaining--;
        countdownOverlay.textContent = Math.max(0, countdownRemaining);

        if (countdownRemaining <= 0) {
          stopCountdown();
          onDone?.();
        }
      }, 1000);
    }

    function goTo(index) {
      const list = effectiveSections();
      if (list.length === 0) return;

      currentIndex = Math.max(0, Math.min(index, list.length - 1));

      const s = list[currentIndex];
      if (s.type === 'finish') {
        if (workoutFinishedSeconds === null) workoutFinishedSeconds = workoutSeconds;
        if (workoutTimer) clearInterval(workoutTimer);
        workoutTimer = null;
        stopCountdown();
      }

      renderSections(); // mantiene highlight e aggiorna player/timeline
      if (!viewSchermo.classList.contains('hidden')) renderTimeline();
    }

    function next(){
      stopCountdown();
      const total = effectiveSections().length;
      if (currentIndex < total - 1) goTo(currentIndex + 1);
    }
    function back(){
      stopCountdown();
      if (currentIndex > 0) goTo(currentIndex - 1);
    }

    function renderPlayer() {
      stopCountdown();

      const list = effectiveSections();

      if (!currentProjectId && sections.length === 0) {
        backBtn.disabled = true;
        nextBtn.disabled = true;
        nextBtn.style.display = 'inline-flex';
        setMediaContent(null);
        return;
      }

      if (sections.length === 0) {
        backBtn.disabled = true;
        nextBtn.disabled = true;
        nextBtn.style.display = 'inline-flex';
        playerTitle.textContent = currentProjectName;
        playerMedia.innerHTML = `<div class="player-empty">Nessuna sezione. Vai su <b>SEZIONI</b> e aggiungine una.</div>`;
        return;
      }

      currentIndex = Math.max(0, Math.min(currentIndex, list.length - 1));
      const s = list[currentIndex];

      backBtn.disabled = (currentIndex === 0);
      nextBtn.disabled = (currentIndex === list.length - 1);
      nextBtn.style.display = 'inline-flex';

      // Se arrivo alla schermata finale: congelo tempo e fermo timer
      if (s.type === 'finish') {
        if (workoutFinishedSeconds === null) workoutFinishedSeconds = workoutSeconds;
        if (workoutTimer) clearInterval(workoutTimer);
        workoutTimer = null;
        stopCountdown();
      }

      setMediaContent(s);

      // Countdown riposo (tasto avanti sempre disponibile)
      if (s.type === 'countdown') {
        startCountdown(s.seconds ?? 30, () => {
          if (currentIndex < list.length - 1) next();
        });
        return;
      }

      // Esercizio con cambio automatico (tasto avanti sempre disponibile)
      if (s.type === 'esercizio' && s.changeMode === 'countdown') {
        startCountdown(s.seconds ?? 30, () => {
          if (currentIndex < list.length - 1) next();
        });
      }
    }

    function renderTimeline() {
      const list = effectiveSections();
      timelineBar.innerHTML = list.map((s, i) => {
        if (s.type === 'finish') {
          return `
            <div class="timeline-item ${i === currentIndex ? 'active' : ''}" onclick="window.__goTo(${i})">
              ‚úÖ ‚Ä¢ END<br>FINE
            </div>
          `;
        }

        const label = (s.type === 'esercizio') ? 'EX' : 'REST';
        const secs = (s.type === 'countdown')
          ? (s.seconds ?? '--')
          : ((s.changeMode === 'countdown') ? (s.seconds ?? '--') : '--');

        const title = (s.type === 'countdown') ? (s.title || 'Riposo') : (s.title || 'Esercizio');

        return `
          <div class="timeline-item ${i === currentIndex ? 'active' : ''}" onclick="window.__goTo(${i})">
            ${label} ‚Ä¢ ${secs}s<br>${escapeHtml(title).slice(0, 14)}
          </div>
        `;
      }).join('');
    }

    // Expose goTo for inline onclick in timeline
    window.__goTo = goTo;

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[s]));
    }

    // =========================
    // Render Sezioni
    // =========================
    function previewFor(s){
      if (!s) return '';
      if (s.type === 'countdown' || s.type === 'finish') return '';
      const media = s.media;
      if (!media || !media.src) return '';
      const src = media.src;

      const isVideo =
        media.kind === 'video' ||
        (media.kind === 'link' && /\.(mp4|webm|ogg)(\?.*)?$/i.test(src));

      // Per video usiamo sempre placeholder
      if (isVideo) return '';
      return src;
    }

    function renderSections() {
      sectionList.innerHTML = '';

      if (sections.length === 0) {
        emptyState.style.display = 'block';
        currentIndex = 0;
        stopCountdown();
        renderPlayer();
        renderTimeline();
        return;
      }
      emptyState.style.display = 'none';

      const list = effectiveSections();

      list.forEach((s, idx) => {
        const isLocked = (s.type === 'finish' || s.locked);

        const card = document.createElement('div');
        card.className = 'card' + (idx === currentIndex ? ' active' : '');

        const top = document.createElement('div');
        top.className = 'card-info';

        const img = document.createElement('img');
        img.className = 'preview-thumb';

        const pv = previewFor(s);
        if (pv) img.src = pv;
        else img.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(
          `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">
            <rect width="100%" height="100%" fill="#2c2c2e"/>
            <text x="50%" y="54%" font-family="Arial" font-size="22" fill="#8e8e93" text-anchor="middle">${
              s.type === 'finish' ? '‚úÖ' : (s.type === 'countdown' ? '‚è±' : 'üèãÔ∏è')
            }</text>
           </svg>`
        );

        const info = document.createElement('div');
        info.className = 'card-text';
        info.style.flex = '1';

        const h3 = document.createElement('h3');
        if (s.type === 'finish') h3.textContent = 'Fine Allenamento';
        else if (s.type === 'esercizio') h3.textContent = ((s.title && s.title.trim()) ? s.title.trim() : 'Esercizio');
        else h3.textContent = ((s.title && s.title.trim()) ? s.title.trim() : 'Riposo');

        const p = document.createElement('p');
        if (s.type === 'finish') p.textContent = 'Schermata finale fissa (non modificabile)';
        else p.textContent = formatSectionLabel(s) + ' ‚Ä¢ ' + metaFor(s);

        info.appendChild(h3);
        info.appendChild(p);

        top.appendChild(img);
        top.appendChild(info);

        card.appendChild(top);

        if (!isLocked) {
          const actions = document.createElement('div');
          actions.className = 'btn-group';

          const mkBtn = (txt, cls, title, onClick, disabled=false) => {
            const b = document.createElement('button');
            b.className = cls;
            b.textContent = txt;
            b.title = title;
            b.disabled = disabled;
            b.addEventListener('click', (e) => { e.stopPropagation(); onClick(); });
            return b;
          };

          actions.appendChild(mkBtn('‚¨ÜÔ∏è', 'btn-icon', 'Sposta su', () => {
            if (idx === 0) return;
            [sections[idx-1], sections[idx]] = [sections[idx], sections[idx-1]];
            if (currentIndex === idx) currentIndex = idx - 1;
            else if (currentIndex === idx - 1) currentIndex = idx;
            renderSections();
            saveCurrentProjectSilently();
          }, idx===0));

          actions.appendChild(mkBtn('‚¨áÔ∏è', 'btn-icon', 'Sposta gi√π', () => {
            if (idx === sections.length - 1) return;
            [sections[idx+1], sections[idx]] = [sections[idx], sections[idx+1]];
            if (currentIndex === idx) currentIndex = idx + 1;
            else if (currentIndex === idx + 1) currentIndex = idx;
            renderSections();
            saveCurrentProjectSilently();
          }, idx===sections.length-1));

          actions.appendChild(mkBtn('üìÑ', 'btn-icon', 'Duplica', () => {
            const copy = JSON.parse(JSON.stringify(sections[idx]));
            sections.splice(idx + 1, 0, copy);
            if (currentIndex > idx) currentIndex++;
            renderSections();
            saveCurrentProjectSilently();
          }));

          actions.appendChild(mkBtn('‚úèÔ∏è', 'btn-icon', 'Modifica', () => openModal('edit', idx)));

          actions.appendChild(mkBtn('üóëÔ∏è', 'btn-danger', 'Elimina', () => {
            sections.splice(idx, 1);
            if (currentIndex > idx) currentIndex--;
            currentIndex = Math.max(0, Math.min(currentIndex, effectiveSections().length - 1));
            renderSections();
            saveCurrentProjectSilently();
          }));

          card.appendChild(actions);
        }

        card.style.cursor = 'pointer';
        card.addEventListener('click', () => {
          currentIndex = idx;
          renderSections();
          if (!viewSchermo.classList.contains('hidden')) renderTimeline();
        });

        sectionList.appendChild(card);
      });

      renderPlayer();
      renderTimeline();
    }

    // =========================
    // Progetti
    // =========================
    async function renderProjects() {
      const projects = await STORAGE.loadProjects();
      projectList.innerHTML = '';

      if (!projects || projects.length === 0) {
        noProjects.style.display = 'block';
        noProjects.textContent = 'Nessun progetto salvato.';
        return;
      }
      noProjects.style.display = 'none';

      projects.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'card';

        const top = document.createElement('div');
        top.className = 'card-info';

        const icon = document.createElement('img');
        icon.className = 'preview-thumb';
        icon.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(
          `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">
            <rect width="100%" height="100%" fill="#2c2c2e"/>
            <text x="50%" y="54%" font-family="Arial" font-size="22" fill="#8e8e93" text-anchor="middle">üìÅ</text>
           </svg>`
        );

        const info = document.createElement('div');
        info.className = 'card-text';
        info.style.flex = '1';

        const title = document.createElement('h3');
        title.textContent = p.name;

        const meta = document.createElement('p');
        meta.textContent = `${(p.sections?.length ?? 0)} sezioni`;

        info.appendChild(title);
        info.appendChild(meta);

        top.appendChild(icon);
        top.appendChild(info);

        const actions = document.createElement('div');
        actions.className = 'btn-group';

        const loadBtn = document.createElement('button');
        loadBtn.className = 'btn-icon';
        loadBtn.textContent = 'üìÇ Carica';
        loadBtn.onclick = async () => {
          sections = JSON.parse(JSON.stringify(p.sections || []));
          currentProjectId = p.id;
          currentProjectName = p.name;
          projectNameInput.value = p.name;
          currentIndex = 0;
          await setBadge();
          renderSections();
          showToast('Progetto caricato');
        };

        const renameBtn = document.createElement('button');
        renameBtn.className = 'btn-icon';
        renameBtn.textContent = 'üè∑Ô∏è';
        renameBtn.title = 'Rinomina';
        renameBtn.onclick = async () => {
          const newName = prompt('Nuovo nome progetto:', p.name);
          if (!newName) return;

          const projects2 = await STORAGE.loadProjects();
          const i = projects2.findIndex(x => x.id === p.id);
          if (i >= 0) {
            projects2[i].name = newName.trim() || projects2[i].name;
            const res = await STORAGE.saveProjects(projects2);
            if (!res.ok) return showToast('Impossibile rinominare: storage bloccato');
            if (currentProjectId === p.id) {
              currentProjectName = projects2[i].name;
              projectNameInput.value = projects2[i].name;
              await setBadge();
            }
            await renderProjects();
            showToast('Rinominato');
          }
        };

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-danger';
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.title = 'Elimina';
        delBtn.onclick = async () => {
          const ok = confirm(`Eliminare il progetto "${p.name}"?`);
          if (!ok) return;

          const projects2 = (await STORAGE.loadProjects()).filter(x => x.id !== p.id);
          const res = await STORAGE.saveProjects(projects2);
          if (!res.ok) return showToast('Impossibile eliminare: storage bloccato');

          if (currentProjectId === p.id) detachCurrentProject();

          await renderProjects();
          showToast('Progetto eliminato');
        };

        actions.appendChild(loadBtn);
        actions.appendChild(renameBtn);
        actions.appendChild(delBtn);

        card.appendChild(top);
        card.appendChild(actions);

        projectList.appendChild(card);
      });
    }

    async function saveNewProjectAlways() {
      const name = projectNameInput.value.trim() || 'Senza nome';
      const projects = await STORAGE.loadProjects();

      const newP = {
        id: uid(),
        name,
        sections: JSON.parse(JSON.stringify(sections)),
        createdAt: Date.now()
      };
      projects.unshift(newP);

      const res = await STORAGE.saveProjects(projects);
      if (!res.ok) return showToast('Impossibile salvare: storage bloccato');

      currentProjectId = newP.id;
      currentProjectName = newP.name;
      await setBadge();
      await renderProjects();
      showToast(`Salvato come nuovo (${res.where})`);
    }

    async function saveCurrentProject() {
      const name = projectNameInput.value.trim() || 'Senza nome';
      const projects = await STORAGE.loadProjects();

      // Se NON c'√® progetto corrente => crea nuovo
      if (!currentProjectId) return await saveNewProjectAlways();

      // Se c'√® progetto corrente => aggiorna
      const idx = projects.findIndex(p => p.id === currentProjectId);
      if (idx >= 0) {
        projects[idx].name = name;
        projects[idx].sections = JSON.parse(JSON.stringify(sections));
        projects[idx].updatedAt = Date.now();

        const res = await STORAGE.saveProjects(projects);
        if (!res.ok) return showToast('Impossibile salvare: storage bloccato');

        currentProjectName = projects[idx].name;
        await setBadge();
        await renderProjects();
        return showToast(`Progetto aggiornato (${res.where})`);
      }

      // Se non lo trova, salva come nuovo
      currentProjectId = null;
      await setBadge();
      return await saveNewProjectAlways();
    }

    // Salvataggio "silenzioso" quando modifichi sezioni (se hai un progetto caricato)
    async function saveCurrentProjectSilently() {
      if (!currentProjectId) return;
      const projects = await STORAGE.loadProjects();
      const idx = projects.findIndex(p => p.id === currentProjectId);
      if (idx >= 0) {
        projects[idx].sections = JSON.parse(JSON.stringify(sections));
        projects[idx].updatedAt = Date.now();
        await STORAGE.saveProjects(projects);
      }
    }

    saveProjectBtn.addEventListener('click', saveCurrentProject);
    saveAsNewBtn.addEventListener('click', saveNewProjectAlways);

    newProjectBtn.addEventListener('click', async () => {
      const ok = confirm('Iniziare un nuovo progetto? (Le sezioni attuali resteranno solo se le salvi prima)');
      if (!ok) return;

      sections = [];
      currentIndex = 0;
      detachCurrentProject();
      renderSections();
      await renderProjects();
      showToast('Nuovo progetto avviato');
    });

    // =========================
    // Fullscreen (vero o finto)
    // =========================
    async function toggleFullscreen() {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const canFs = !isIOS && !!(screen.requestFullscreen && document.fullscreenEnabled);

      if (canFs) {
        try {
          if (!document.fullscreenElement) await screen.requestFullscreen();
          else await document.exitFullscreen();
          return;
        } catch {
          // fallback a pseudo
        }
      }

      const isPseudo = screen.classList.contains('pseudo-fullscreen');
      screen.classList.toggle('pseudo-fullscreen', !isPseudo);

      // nascondi header + tab bar in pseudo
      document.getElementById('appHeader').classList.toggle('hide-when-pseudo', !isPseudo);
      document.getElementById('tabBar').classList.toggle('hide-when-pseudo', !isPseudo);
      
      fullscreenBtn.textContent = !isPseudo ? '‚§¢' : '‚õ∂';
    }

    document.addEventListener('fullscreenchange', () => {
      fullscreenBtn.textContent = document.fullscreenElement ? '‚§¢' : '‚õ∂';
    });

    fullscreenBtn.addEventListener('click', toggleFullscreen);
    backBtn.addEventListener('click', back);
    nextBtn.addEventListener('click', next);

    // =========================
    // Workout timer
    // =========================
    function startWorkout() {
      // prova fullscreen vero, altrimenti l'utente pu√≤ usare il tasto ‚õ∂
      toggleFullscreen().catch(() => {});
      workoutFinishedSeconds = null;
      workoutSeconds = 0;
      timerDisplay.textContent = '00:00';

      if (workoutTimer) clearInterval(workoutTimer);

      workoutTimer = setInterval(() => {
        workoutSeconds++;
        const mins = Math.floor(workoutSeconds / 60).toString().padStart(2, '0');
        const secs = (workoutSeconds % 60).toString().padStart(2, '0');
        timerDisplay.textContent = `${mins}:${secs}`;
      }, 1000);

      currentIndex = 0;
      renderPlayer();
      renderTimeline();
      showToast('Workout avviato');
    }
    btnAvviaWorkout.addEventListener('click', startWorkout);

    // =========================
    // Init
    // =========================
    (async function init(){
      switchTypeUI();
      switchExerciseModeUI();
      await setBadge();
      await renderProjects();
      renderSections();
      switchTab('progetti');
    })();
  </script>
</body>
</html>
